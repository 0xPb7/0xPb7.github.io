I"¿<p><img src="https://miro.medium.com/v2/resize:fit:1400/0*v2mhOVlizpRg9V4e" alt="" /></p>

<p><strong>Challenge Link:</strong>Â <a href="https://challenge-0223.intigriti.io/">https://challenge-0223.intigriti.io/</a></p>

<p><strong>Challenge By:</strong>Â <a href="https://twitter.com/x64pr0fessor">https://twitter.com/x64pr0fessor</a></p>

<p><strong>Goal:</strong>Â Now we understand that we need to find a method to display an alert box in order to confirm that this is indeed an instance of XSS.</p>

<h1 id="reconnaissance">Reconnaissance</h1>

<p>We were given an application that allows us to create â€œLeek NFTâ€ by uploading your own picture as background. After uploading the image you have to submit. Youâ€™ll see a message â€œ<strong><em>file uploaded successfully to 355fed1f-a3ed-44cd-b708â€“93e1c6f2559aâ€.</em></strong>Â _Where â€œ355fed1f-a3ed-44cd-b708â€“93e1c6f2559aâ€ is some kind of UUID or other identifier of session and uploaded file.</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/0*Ui72KpnraowigP91" alt="" /></p>

<p>Now click on save. Youâ€™ll be redirected to the main NFT page</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/0*K5NmIR5keQJcPrUa" alt="" /></p>

<p>I donâ€™t see any changes on the UI, which led me to access the page source to search for helpful information or JavaScript</p>

<p>view-source:https://challenge-0223.intigriti.io/view?viewId=355fed1f-a3ed-44cd-b708-93e1c6f2559a</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/0*Ut030iWIvwXfQoKq" alt="" /></p>

<p>Upon reviewing the JavaScript code, I have realized that the application verifies specific metadata of the uploaded image, such as â€œ<code class="language-plaintext highlighter-rouge">UserComment</code>,â€ â€œ<code class="language-plaintext highlighter-rouge">DateTimeOriginal</code>,â€ and â€œ<code class="language-plaintext highlighter-rouge">OwnerName</code>.â€ This information is retrieved directly from the imageâ€™s Exif data.</p>

<p>The retrieved information is added to the JSON string.</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/0*F0r0DX7iI6ELoIew" alt="" /></p>

<p>The application concatenates strings without performing any sanitization, providing attackers with a potential entry point to inject any form of data into the â€œ<strong><code class="language-plaintext highlighter-rouge">_imjobj_</code></strong>â€ variable.</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/0*KJUrlaJv4Y-T0k3n" alt="" /></p>

<p>TheÂ <strong><code class="language-plaintext highlighter-rouge">_imgName_</code></strong>Â variable in the code cannot be modified because it is hardcoded, intentionally.</p>

<p><strong>Exploitation:</strong></p>

<p>With the help of the potential entry point inÂ <strong>â€œ<code class="language-plaintext highlighter-rouge">_imgobj</code>_â€</strong>Â we could add another key namedÂ <strong>â€œ<code class="language-plaintext highlighter-rouge">imgName</code>â€</strong>Â at the end of the JSON String.</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/0*r0FNPniX_fl7EnVv" alt="" /></p>

<p>Consider the below case:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{  
  "key1":"Naruto",  
  "key1":"Gojo"  
}
</code></pre></div></div>
<p>The final value ofÂ <strong><code class="language-plaintext highlighter-rouge">key1</code></strong>Â would beÂ <strong><code class="language-plaintext highlighter-rouge">Gojo</code>.</strong>Â Because, as mentioned above <code class="language-plaintext highlighter-rouge">JSON.parse()</code> would always take the value of the last key for multiple keys with the same name.</p>

<p>With the above information we could craft a payload in theÂ <strong><code class="language-plaintext highlighter-rouge">imjobj</code></strong>Â JSON string</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{  
  "imgName":"NFT.jpg",  
  "imgColorType":"02/14/2023, 20:09:16",  
  "imgComment":"0xPrashanth",  
  "imgName":"&lt;img src=x onerror=alert(document.domain)&gt;"  
}
</code></pre></div></div>

<p>In order to achieve the above format inject the payload in theÂ <strong><code class="language-plaintext highlighter-rouge">imgComment</code></strong>Â field usingÂ <strong>exiftool</strong>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>exiftool -UserComment='pr0shx", "imgName": "&lt;img src=x onerror=alert(document.domain)&gt;' image.png
</code></pre></div></div>

<p>So, now upload the image.png toÂ <a href="https://challenge-0223.intigriti.io/create"><em>https://challenge-0223.intigriti.io/create</em></a>Â and submit it. Click on save, you can see anÂ <strong><em>alert</em></strong>Â box is popped in the challenge domain as shown below.</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/0*zz0jlElkVgfUp_Nv" alt="" /></p>

<p>This attack works because the application does not sanitize user input and assume hardcoded values are immutable. CreatingÂ <strong><code class="language-plaintext highlighter-rouge">imgobj</code></strong>Â should be done as an object in the first place instead of creating a JSON string and parsing it to a JavaScript object.</p>

<blockquote>
  <p>Prepared by Prashanth in collaboration with Pawel.</p>
</blockquote>

<p><strong>Connect with us at -</strong></p>

<p>Twitter â€”Â <a href="https://twitter.com/_0xPb">Prashanth</a>,Â <a href="https://twitter.com/0xSovietBeast">Pawel</a></p>
:ET